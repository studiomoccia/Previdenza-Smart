<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previdenza Smart — Simulatore Riscattabilità 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #4f46e5; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .slider-thumb::-moz-range-thumb { width: 24px; height: 24px; background: #4f46e5; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        input[type=number]::-webkit-inner-spin-button { opacity: 0.5; }
        .coeff-option { transition: all 0.2s ease; cursor: pointer; }
        .coeff-option:hover { transform: translateY(-1px); }
        .coeff-option.active-static { border-color: #10b981; background-color: #ecfdf5; box-shadow: 0 0 0 3px rgba(16,185,129,0.15); }
        .coeff-option.active-dynamic { border-color: #f59e0b; background-color: #fffbeb; box-shadow: 0 0 0 3px rgba(245,158,11,0.15); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Header -->
    <header class="bg-indigo-900 text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold"><i class="fa-solid fa-shield-halved mr-3"></i>Previdenza Smart</h1>
                <p class="text-indigo-200 text-sm mt-1">Simulatore Riscattabilità — Art. 11 D.Lgs 252/2005 — Legge di Bilancio 2026</p>
                <p class="text-indigo-300 text-xs mt-0.5">Dal 1/7/2026: max 60% capitale, min 40% rendita (se sopra soglia)</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <div class="text-xs uppercase tracking-wider text-indigo-300">Assegno Sociale 2026</div>
                <div class="text-2xl font-bold">€ 7.101,12</div>
                <div class="text-xs text-indigo-300">Soglia 50%: € 3.550,56 (€ 273/mese × 13)</div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- ═══════════════════════════════════════ COLONNA INPUT ═══════════════════════════════════════ -->
        <div class="lg:col-span-1 space-y-6">

            <!-- 1. Profilo & Posizione -->
            <div class="bg-white p-6 rounded-xl card-shadow border border-slate-200">
                <h2 class="text-lg font-semibold text-slate-700 mb-4 border-b pb-2"><i class="fa-regular fa-id-card mr-2"></i>Profilo & Posizione</h2>
                <label class="block mb-3">
                    <span class="text-sm font-medium text-slate-600">Montante Attuale (€)</span>
                    <input type="text" id="montanteAttuale" value="50.000" oninput="formatCurrencyInput(this)" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm bg-slate-50 border p-2 focus:border-indigo-500 font-semibold text-slate-700">
                </label>
                <div class="grid grid-cols-3 gap-3">
                    <label class="block mb-3">
                        <span class="text-sm font-medium text-slate-600">Anno Nascita</span>
                        <input type="number" id="annoNascita" value="1980" min="1950" max="2005" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm bg-slate-50 border p-2 text-center">
                    </label>
                    <label class="block mb-3">
                        <span class="text-sm font-medium text-slate-600">Anni Pensione</span>
                        <input type="number" id="anniAlPensionamento" value="15" min="1" max="45" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm bg-slate-50 border p-2 text-center">
                    </label>
                    <label class="block mb-3">
                        <span class="text-sm font-medium text-slate-600">Sesso</span>
                        <select id="sesso" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm bg-slate-50 border p-2">
                            <option value="M">Uomo</option>
                            <option value="F">Donna</option>
                        </select>
                    </label>
                </div>
                <div id="profiloRiepilogo" class="bg-slate-50 rounded-lg p-2 text-center">
                    <p class="text-xs text-slate-500">Età al pensionamento: <span id="outEtaPensione" class="font-bold text-indigo-700">--</span> anni · Anno uscita: <span id="outAnnoUscita" class="font-bold text-indigo-700">--</span></p>
                </div>
            </div>

            <!-- 2. Coefficiente: Statico vs Dinamico -->
            <div class="bg-white p-6 rounded-xl card-shadow border border-slate-200">
                <h2 class="text-lg font-semibold text-slate-700 mb-2 border-b pb-2"><i class="fa-solid fa-user-clock mr-2"></i>Coefficiente di Conversione</h2>
                <p class="text-xs text-slate-400 mb-4">Come stimare il coefficiente che il fondo userà al momento della rendita?</p>

                <div class="grid grid-cols-1 gap-3" id="coeffChoices">
                    <!-- Opzione STATICO -->
                    <div id="optStatic" class="coeff-option active-static border-2 rounded-xl p-4" onclick="selectCoeffMode('static')">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 mt-0.5">
                                <div id="radioStatic" class="w-5 h-5 rounded-full border-2 border-emerald-500 flex items-center justify-center">
                                    <div class="w-2.5 h-2.5 rounded-full bg-emerald-500"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-bold text-emerald-700">Coefficienti Statici</span>
                                    <span class="text-[9px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded-full font-semibold uppercase">Prudente</span>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">Usa i coefficienti attuali (2024), invariati nel tempo. Ipotesi più favorevole: rendita più alta → più facile superare la soglia.</p>
                                <div class="mt-2 bg-emerald-50 rounded-lg px-3 py-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-[10px] text-emerald-600 font-semibold">Coeff. risultante</span>
                                        <span id="valCoeffStatic" class="text-lg font-bold text-emerald-800">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Opzione DINAMICO -->
                    <div id="optDynamic" class="coeff-option border-2 border-slate-200 rounded-xl p-4" onclick="selectCoeffMode('dynamic')">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 mt-0.5">
                                <div id="radioDynamic" class="w-5 h-5 rounded-full border-2 border-slate-300 flex items-center justify-center">
                                    <div class="w-2.5 h-2.5 rounded-full bg-transparent"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-bold text-amber-700">Coefficienti Dinamici</span>
                                    <span class="text-[9px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded-full font-semibold uppercase">Realistico</span>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">Proiettati al tuo anno di uscita (Tariffa 75A0). Con l'aumento della speranza di vita i coefficienti calano → rendita più bassa → più facile restare sotto soglia.</p>
                                <div class="mt-2 bg-amber-50 rounded-lg px-3 py-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-[10px] text-amber-600 font-semibold">Coeff. proiettato</span>
                                        <span id="valCoeffDynamic" class="text-lg font-bold text-amber-800">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dettaglio sotto -->
                <div class="mt-3 bg-slate-50 rounded-lg p-3">
                    <div class="flex justify-between text-xs">
                        <span class="text-slate-500">Differenza Statico vs Dinamico</span>
                        <span id="coeffDelta" class="font-bold text-slate-700">--</span>
                    </div>
                    <p id="coeffSessoNote" class="text-[10px] text-slate-400 mt-1.5 italic"></p>
                </div>
            </div>

            <!-- 3. Flussi Contributivi -->
            <div class="bg-white p-6 rounded-xl card-shadow border border-slate-200">
                <h2 class="text-lg font-semibold text-slate-700 mb-4 border-b pb-2"><i class="fa-solid fa-coins mr-2"></i>Flussi Contributivi</h2>
                <label class="block mb-3">
                    <span class="text-sm font-medium text-slate-600">Reddito Lordo Annuo (RAL) €</span>
                    <input type="text" id="ral" value="35.000" oninput="formatCurrencyInput(this)" class="mt-1 block w-full rounded-md border-slate-300 bg-slate-50 border p-2 font-semibold text-slate-700">
                </label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="block mb-2">
                        <span class="text-xs font-medium text-slate-500">Contributo Lavoratore %</span>
                        <input type="number" id="percLav" value="1.0" step="0.1" min="0" class="mt-1 w-full border rounded p-1 text-center">
                    </label>
                    <label class="block mb-2">
                        <span class="text-xs font-medium text-slate-500">Contributo Datore %</span>
                        <input type="number" id="percDatore" value="1.5" step="0.1" min="0" class="mt-1 w-full border rounded p-1 text-center">
                    </label>
                </div>
                <label class="block mb-3 flex items-center justify-between">
                    <span class="text-sm font-medium text-slate-600">Versamento TFR (≈ 7,41%)</span>
                    <input type="checkbox" id="includeTFR" checked class="rounded text-indigo-600 focus:ring-indigo-500 h-5 w-5">
                </label>
                <label class="block mb-3">
                    <span class="text-sm font-medium text-slate-600">Crescita Salariale Annua (%)</span>
                    <input type="number" id="crescitaSalari" value="1.5" step="0.1" min="0" class="mt-1 block w-full rounded-md border-slate-300 bg-slate-50 border p-2">
                </label>

                <details class="mt-2">
                    <summary class="text-xs text-slate-400 cursor-pointer hover:text-indigo-600">Crescita aliquote contributive (avanzato)</summary>
                    <div class="mt-2 bg-slate-50 rounded-lg p-3 space-y-2">
                        <label class="block">
                            <div class="flex justify-between">
                                <span class="text-xs text-slate-500">Crescita annua % Lavoratore</span>
                                <span class="text-xs font-mono text-slate-600" id="valCresLav">0.0%</span>
                            </div>
                            <input type="range" id="crescitaPercLav" min="0" max="5" step="0.1" value="0" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer slider-thumb mt-1">
                        </label>
                        <label class="block">
                            <div class="flex justify-between">
                                <span class="text-xs text-slate-500">Crescita annua % Datore</span>
                                <span class="text-xs font-mono text-slate-600" id="valCresDat">0.0%</span>
                            </div>
                            <input type="range" id="crescitaPercDat" min="0" max="5" step="0.1" value="0" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer slider-thumb mt-1">
                        </label>
                    </div>
                </details>
            </div>

            <!-- 4. Mercato & Inflazione -->
            <div class="bg-white p-6 rounded-xl card-shadow border border-slate-200">
                <h2 class="text-lg font-semibold text-slate-700 mb-4 border-b pb-2"><i class="fa-solid fa-chart-line mr-2"></i>Mercato & Inflazione</h2>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>Rendimento Netto Fondo (%)</span>
                            <span id="valRend">3.0%</span>
                        </div>
                        <input type="range" id="rendimento" min="0" max="8" step="0.1" value="3.0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>Inflazione Attesa (%)</span>
                            <span id="valInf">2.0%</span>
                        </div>
                        <input type="range" id="inflazione" min="0" max="6" step="0.1" value="2.0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    </div>
                </div>
            </div>

            <!-- Riepilogo Contributo anno 1 -->
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                <p class="text-[10px] text-indigo-500 uppercase font-semibold mb-2">Contributo Annuo (anno 1)</p>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div>
                        <p class="text-[10px] text-slate-500">Lav+Datore</p>
                        <p id="outContribLD" class="text-sm font-bold text-slate-700">€ 0</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-500">TFR</p>
                        <p id="outContribTFR" class="text-sm font-bold text-slate-700">€ 0</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-500">Totale</p>
                        <p id="outContribTot" class="text-sm font-bold text-indigo-600">€ 0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════ COLONNA RISULTATI ═══════════════════════════════════════ -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Card Esito Principale -->
            <div id="resultCard" class="p-8 rounded-2xl shadow-xl text-center transition-all duration-500 bg-gray-100">
                <div class="animate-pulse flex justify-center items-center h-24">
                    <span class="text-gray-400">Calcolo in corso...</span>
                </div>
            </div>

            <!-- Griglia Valori -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                    <p class="text-xs text-slate-500 uppercase font-semibold">Montante Finale Atteso (MFA)</p>
                    <p id="outMFA" class="text-2xl font-bold text-slate-800">€ 0</p>
                    <p class="text-xs text-green-600 mt-1"><i class="fa-solid fa-arrow-trend-up"></i> <span id="outMFAreale">reale: € 0</span></p>
                </div>
                <div class="bg-white p-4 rounded-xl border border-indigo-200 shadow-sm">
                    <p class="text-xs text-slate-500 uppercase font-semibold">Rendita Annuale da 70% MFA</p>
                    <p id="outRendita70" class="text-2xl font-bold text-indigo-600">€ 0</p>
                    <p class="text-xs text-green-600 mt-1"><i class="fa-solid fa-coins"></i> <span id="outRendita70reale">reale: € 0</span></p>
                </div>
                <div class="bg-white p-4 rounded-xl border border-red-200 shadow-sm relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-2 opacity-10"><i class="fa-solid fa-gavel fa-3x"></i></div>
                    <p class="text-xs text-slate-500 uppercase font-semibold">Soglia Legge (50% AS Rivalutato)</p>
                    <p id="outSoglia" class="text-2xl font-bold text-red-600">€ 0</p>
                    <p class="text-xs text-red-400 mt-1"><span id="outSogliaMensile">€ 0/mese × 13</span></p>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                    <p class="text-xs text-slate-500 uppercase font-semibold">Gap (Soglia − Rendita)</p>
                    <p id="outGap" class="text-2xl font-bold text-slate-800">€ 0</p>
                    <p id="outGapDesc" class="text-xs mt-1">--</p>
                </div>
            </div>

            <!-- Soglia Limite Montante -->
            <div id="sogliaLimiteCard" class="bg-amber-50 border border-amber-300 p-4 rounded-xl flex items-center gap-4">
                <div class="flex-shrink-0 text-3xl text-amber-500"><i class="fa-solid fa-triangle-exclamation"></i></div>
                <div>
                    <p class="text-xs text-amber-700 uppercase font-semibold">Soglia Limite Montante (per ottenere 100% Capitale)</p>
                    <p id="outSogliaLimMont" class="text-xl font-bold text-amber-800">€ 0</p>
                    <p class="text-xs text-amber-600 mt-0.5">Margine residuo: <span id="outMargineLimite" class="font-semibold">€ 0</span></p>
                </div>
            </div>

            <!-- Dettaglio Obbligo Rendita (solo se KO) -->
            <div id="dettaglioRendita" class="hidden bg-red-50 border border-red-200 p-5 rounded-xl">
                <h3 class="text-sm font-bold text-red-700 uppercase mb-3"><i class="fa-solid fa-hand-holding-dollar mr-1"></i>Dettaglio Obbligo Rendita (dal 1/7/2026)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs text-red-500">Max 60% Capitale</p>
                        <p id="outMax60" class="text-lg font-bold text-slate-800">€ 0</p>
                    </div>
                    <div>
                        <p class="text-xs text-red-500">Min 40% Rendita Annua</p>
                        <p id="outMin40rendita" class="text-lg font-bold text-slate-800">€ 0</p>
                        <p class="text-xs text-green-600 mt-0.5"><span id="outMin40reale">reale: € 0</span></p>
                    </div>
                </div>
            </div>

            <!-- Grafico -->
            <div class="bg-white p-6 rounded-xl card-shadow border border-slate-200">
                <h3 class="text-sm font-bold text-slate-500 uppercase mb-4">Proiezione Temporale Accumulo</h3>
                <div class="relative h-64 w-full">
                    <canvas id="projectionChart"></canvas>
                </div>
                <div class="mt-2 text-xs text-center text-slate-400">
                    <span class="inline-block w-3 h-1 bg-indigo-500 mr-1"></span> Montante Previsto
                    <span class="inline-block w-3 h-1 bg-red-500 ml-3 mr-1 border-b border-dashed border-red-500"></span> Limite Max per riscatto 100% capitale
                </div>
            </div>

            <!-- Tabella Proiezione (collapsible) -->
            <details class="bg-white rounded-xl card-shadow border border-slate-200">
                <summary class="p-4 cursor-pointer text-sm font-semibold text-slate-600 hover:text-indigo-600">
                    <i class="fa-solid fa-table mr-2"></i>Tabella Proiezione Anno per Anno
                </summary>
                <div class="overflow-x-auto px-4 pb-4">
                    <table id="projTable" class="w-full text-xs">
                        <thead>
                            <tr class="bg-indigo-900 text-white">
                                <th class="p-2 text-center rounded-tl-lg">Anno</th>
                                <th class="p-2 text-right">RAL (€)</th>
                                <th class="p-2 text-right">%Lav</th>
                                <th class="p-2 text-right">%Dat</th>
                                <th class="p-2 text-right">Contr. L+D (€)</th>
                                <th class="p-2 text-right">TFR (€)</th>
                                <th class="p-2 text-right">Tot. Contr. (€)</th>
                                <th class="p-2 text-right">Rendim. (€)</th>
                                <th class="p-2 text-right rounded-tr-lg font-bold">Montante (€)</th>
                            </tr>
                        </thead>
                        <tbody id="projBody"></tbody>
                    </table>
                </div>
            </details>

            <!-- Note -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0"><i class="fa-solid fa-circle-info text-blue-500"></i></div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <strong>Statici vs Dinamici:</strong> I coefficienti <em>statici</em> fotografano i valori attuali (2024). I <em>dinamici</em> proiettano l'effetto dell'allungamento della speranza di vita (Tariffa 75A0, tasso tecnico 0%, base ISTAT). Coefficienti più bassi → rendita più bassa → più facile ottenere il 100% in capitale.
                        </p>
                        <p class="text-sm text-blue-700 mt-1">
                            <strong>Strategia:</strong> Seconde/terze posizioni separate per mantenere ciascun montante sotto la soglia limite. La portabilità del contributo datoriale potrebbe ampliare questa possibilità.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="max-w-7xl mx-auto px-6 py-4 text-center text-[10px] text-slate-400">
        Art. 11, co. 3, D.Lgs 252/2005 — Legge di Bilancio 2026 — Previdenza Smart V3 — Simulazione a scopo indicativo, non costituisce consulenza.
    </footer>

    <script>
        // ═══════ MATRICE COEFFICIENTI (Tariffa 75A0, tasso tecnico 0%, proiezione 2024-2060) ═══════
        const COEFF_DATA = {"ages":[50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70],"years":[2024,2025,2026,2027,2028,2029,2030,2031,2032,2033,2034,2035,2036,2037,2038,2039,2040,2041,2042,2043,2044,2045,2046,2047,2048,2049,2050,2051,2052,2053,2054,2055,2056,2057,2058,2059,2060],"M":[[0.029561,0.030407,0.031301,0.032247,0.033251,0.034315,0.035446,0.036647,0.037925,0.039287,0.040742,0.042303,0.043978,0.045779,0.047718,0.049809,0.052069,0.054517,0.057175,0.060065,0.063216],[0.029315,0.030148,0.031028,0.031958,0.032946,0.033992,0.035103,0.036282,0.037537,0.038873,0.0403,0.041829,0.043469,0.045232,0.047128,0.049171,0.051377,0.053765,0.056354,0.059167,0.062229],[0.029073,0.029893,0.030759,0.031675,0.032646,0.033674,0.034766,0.035925,0.037156,0.038468,0.039867,0.041366,0.042973,0.044698,0.046552,0.048549,0.050704,0.053033,0.055557,0.058295,0.061273],[0.028835,0.029642,0.030495,0.031396,0.032351,0.033363,0.034436,0.035574,0.036784,0.038071,0.039443,0.040913,0.042487,0.044176,0.045991,0.047943,0.050047,0.052321,0.054781,0.057448,0.060345],[0.028601,0.029396,0.030235,0.031122,0.032062,0.033057,0.034112,0.035231,0.036418,0.037682,0.039028,0.040469,0.042012,0.043666,0.045442,0.047351,0.049408,0.051627,0.054028,0.056626,0.059445],[0.02837,0.029154,0.02998,0.030853,0.031778,0.032757,0.033794,0.034893,0.03606,0.037301,0.038622,0.040035,0.041548,0.043168,0.044907,0.046774,0.048785,0.050952,0.053294,0.055827,0.058572],[0.028143,0.028915,0.029729,0.030589,0.031499,0.032462,0.033482,0.034563,0.035709,0.036927,0.038224,0.039611,0.041093,0.042681,0.044384,0.046211,0.048177,0.050294,0.05258,0.05505,0.057724],[0.02792,0.028681,0.029483,0.030329,0.031225,0.032172,0.033176,0.034238,0.035365,0.036561,0.037834,0.039195,0.040649,0.042206,0.043873,0.045662,0.047584,0.049653,0.051885,0.054294,0.0569],[0.0277,0.02845,0.02924,0.030074,0.030956,0.031888,0.032875,0.03392,0.035027,0.036202,0.037452,0.038788,0.040214,0.04174,0.043374,0.045125,0.047006,0.049029,0.051209,0.053559,0.056099],[0.027484,0.028223,0.029001,0.029822,0.030691,0.031608,0.03258,0.033607,0.034695,0.03585,0.037078,0.038389,0.039789,0.041285,0.042886,0.044601,0.046441,0.048419,0.050549,0.052844,0.05532],[0.027271,0.028,0.028767,0.029575,0.030431,0.031334,0.032289,0.0333,0.03437,0.035505,0.036711,0.037999,0.039372,0.040839,0.042408,0.044088,0.04589,0.047825,0.049907,0.052147,0.054563],[0.027062,0.02778,0.028536,0.029332,0.030175,0.031064,0.032004,0.032999,0.034051,0.035167,0.036352,0.037616,0.038964,0.040403,0.041942,0.043588,0.045352,0.047245,0.04928,0.051469,0.053826],[0.026855,0.027563,0.028308,0.029093,0.029923,0.030798,0.031724,0.032703,0.033738,0.034835,0.035999,0.037241,0.038564,0.039977,0.041485,0.043098,0.044826,0.046679,0.048669,0.050808,0.053109],[0.026652,0.02735,0.028084,0.028858,0.029676,0.030538,0.031449,0.032412,0.03343,0.034509,0.035653,0.036873,0.038172,0.039559,0.041039,0.04262,0.044312,0.046126,0.048073,0.050163,0.052411],[0.026452,0.02714,0.027864,0.028627,0.029432,0.030281,0.031179,0.032126,0.033128,0.034189,0.035314,0.036513,0.037789,0.03915,0.040601,0.042152,0.04381,0.045587,0.047492,0.049535,0.051731],[0.026255,0.026933,0.027647,0.028399,0.029193,0.030029,0.030913,0.031846,0.032832,0.033875,0.034981,0.036159,0.037413,0.038749,0.040173,0.041694,0.04332,0.045059,0.046924,0.048923,0.051068],[0.02606,0.02673,0.027434,0.028175,0.028957,0.029781,0.030652,0.03157,0.03254,0.033567,0.034654,0.035812,0.037044,0.038356,0.039754,0.041246,0.04284,0.044544,0.04637,0.048325,0.050422],[0.025869,0.026529,0.027224,0.027954,0.028725,0.029537,0.030395,0.031299,0.032254,0.033264,0.034334,0.035472,0.036683,0.037971,0.039344,0.040808,0.04237,0.044041,0.045828,0.047742,0.049792],[0.02568,0.026332,0.027017,0.027737,0.028497,0.029297,0.030142,0.031033,0.031973,0.032967,0.034019,0.035138,0.036328,0.037594,0.038942,0.040378,0.041911,0.043548,0.0453,0.047172,0.049178],[0.025494,0.026137,0.026813,0.027523,0.028272,0.029061,0.029894,0.030771,0.031696,0.032675,0.03371,0.034811,0.03598,0.037224,0.038548,0.039958,0.041462,0.043067,0.044783,0.046617,0.048579],[0.025311,0.025945,0.026612,0.027313,0.028051,0.028829,0.029649,0.030513,0.031425,0.032388,0.033407,0.034489,0.035639,0.036862,0.038162,0.039547,0.041022,0.042596,0.044278,0.046074,0.047994],[0.02513,0.025756,0.026414,0.027105,0.027834,0.0286,0.029409,0.03026,0.031158,0.032106,0.033109,0.034174,0.035304,0.036506,0.037784,0.039143,0.040591,0.042135,0.043784,0.045543,0.047423],[0.024952,0.02557,0.026219,0.026901,0.027619,0.028375,0.029172,0.030011,0.030895,0.031829,0.032816,0.033864,0.034976,0.036157,0.037413,0.038748,0.04017,0.041685,0.043301,0.045025,0.046865],[0.024777,0.025387,0.026027,0.0267,0.027408,0.028154,0.028939,0.029766,0.030637,0.031556,0.032528,0.03356,0.034654,0.035815,0.037049,0.038361,0.039757,0.041243,0.042829,0.044518,0.046321],[0.024603,0.025206,0.025838,0.026501,0.027201,0.027936,0.02871,0.029525,0.030383,0.031289,0.032245,0.033261,0.034337,0.03548,0.036693,0.037981,0.039352,0.040811,0.042366,0.044023,0.045789],[0.024433,0.025027,0.025651,0.026306,0.026996,0.027721,0.028485,0.029288,0.030134,0.031025,0.031968,0.032967,0.034026,0.03515,0.036343,0.037609,0.038956,0.040388,0.041914,0.043538,0.045269],[0.024264,0.024851,0.025467,0.026114,0.026794,0.027509,0.028262,0.029054,0.029888,0.030767,0.031695,0.032679,0.033721,0.034827,0.036,0.037244,0.038567,0.039974,0.041471,0.043064,0.04476],[0.024098,0.024678,0.025286,0.025924,0.026596,0.027301,0.028044,0.028825,0.029646,0.030512,0.031426,0.032395,0.033421,0.034509,0.035663,0.036887,0.038186,0.039568,0.041038,0.0426,0.044263],[0.023934,0.024507,0.025107,0.025737,0.0264,0.027096,0.027829,0.028598,0.029409,0.030262,0.031162,0.032117,0.033127,0.034197,0.035332,0.036535,0.037813,0.03917,0.040613,0.042147,0.043777],[0.023773,0.024338,0.024931,0.025553,0.026207,0.026894,0.027617,0.028376,0.029175,0.030016,0.030903,0.031843,0.032837,0.033891,0.035008,0.036191,0.037447,0.03878,0.040197,0.041702,0.043302],[0.023613,0.024172,0.024757,0.025371,0.026017,0.026695,0.027408,0.028157,0.028944,0.029773,0.030648,0.031573,0.032553,0.03359,0.034689,0.035853,0.037088,0.038398,0.03979,0.041267,0.042836],[0.023456,0.024008,0.024586,0.025192,0.02583,0.026499,0.027202,0.027941,0.028718,0.029535,0.030397,0.031309,0.032273,0.033295,0.034376,0.035521,0.036735,0.038023,0.039391,0.040841,0.042381],[0.023301,0.023846,0.024417,0.025016,0.025645,0.026305,0.027,0.027728,0.028494,0.0293,0.03015,0.031048,0.031999,0.033004,0.034069,0.035196,0.03639,0.037656,0.038999,0.040424,0.041935],[0.023148,0.023686,0.02425,0.024842,0.025463,0.026115,0.0268,0.027519,0.028275,0.029069,0.029907,0.030792,0.031729,0.032719,0.033767,0.034876,0.03605,0.037295,0.038616,0.040015,0.041498],[0.022997,0.023529,0.024086,0.02467,0.025284,0.025927,0.026604,0.027313,0.028058,0.028842,0.029668,0.030541,0.031463,0.032439,0.03347,0.034562,0.035717,0.036942,0.03824,0.039614,0.041071],[0.022847,0.023373,0.023924,0.024501,0.025107,0.025742,0.02641,0.02711,0.027845,0.028618,0.029432,0.030293,0.031202,0.032163,0.033179,0.034253,0.035391,0.036595,0.037871,0.039221,0.040652],[0.0227,0.02322,0.023764,0.024334,0.024932,0.02556,0.026219,0.02691,0.027635,0.028398,0.029201,0.030049,0.030945,0.031892,0.032893,0.03395,0.03507,0.036254,0.037509,0.038836,0.040242]],"F":[[0.025754,0.02641,0.027101,0.027829,0.028597,0.029408,0.030267,0.031177,0.032143,0.03317,0.034265,0.035433,0.036681,0.038017,0.039451,0.040993,0.042654,0.044449,0.046393,0.048504,0.050805],[0.025626,0.026277,0.026961,0.027683,0.028443,0.029246,0.030097,0.030998,0.031954,0.03297,0.034054,0.035209,0.036443,0.037764,0.039181,0.040705,0.042346,0.044118,0.046037,0.04812,0.05039],[0.0255,0.026145,0.026823,0.027538,0.028291,0.029087,0.029929,0.030821,0.031767,0.032773,0.033845,0.034988,0.036209,0.037514,0.038915,0.040421,0.042042,0.043792,0.045687,0.047743,0.049982],[0.025375,0.026014,0.026686,0.027394,0.028141,0.028929,0.029763,0.030646,0.031583,0.032578,0.033639,0.03477,0.035977,0.037268,0.038653,0.040141,0.041742,0.043471,0.045342,0.047371,0.049581],[0.025251,0.025884,0.026551,0.027252,0.027992,0.028772,0.029598,0.030473,0.0314,0.032386,0.033435,0.034554,0.035748,0.037025,0.038394,0.039865,0.041447,0.043155,0.045002,0.047005,0.049186],[0.025129,0.025756,0.026417,0.027112,0.027845,0.028618,0.029436,0.030302,0.03122,0.032195,0.033234,0.034341,0.035522,0.036785,0.038139,0.039593,0.041156,0.042843,0.044668,0.046645,0.048797],[0.025007,0.025629,0.026284,0.026973,0.027699,0.028465,0.029275,0.030133,0.031042,0.032007,0.033036,0.034131,0.035299,0.036548,0.037887,0.039324,0.040869,0.042536,0.044338,0.04629,0.048414],[0.024887,0.025504,0.026152,0.026835,0.027555,0.028313,0.029116,0.029965,0.030866,0.031822,0.032839,0.033923,0.035079,0.036314,0.037638,0.039059,0.040586,0.042233,0.044013,0.045941,0.048037],[0.024768,0.025379,0.026022,0.026699,0.027412,0.028164,0.028959,0.0298,0.030692,0.031638,0.032645,0.033718,0.034861,0.036084,0.037393,0.038797,0.040307,0.041934,0.043693,0.045597,0.047666],[0.02465,0.025256,0.025893,0.026564,0.027271,0.028016,0.028803,0.029636,0.030519,0.031456,0.032453,0.033515,0.034647,0.035856,0.03715,0.038539,0.040032,0.04164,0.043377,0.045258,0.047301],[0.024533,0.025134,0.025766,0.026431,0.027131,0.027869,0.028649,0.029475,0.030349,0.031277,0.032264,0.033314,0.034434,0.03563,0.036911,0.038285,0.03976,0.04135,0.043066,0.044924,0.046941],[0.024417,0.025013,0.02564,0.026299,0.026992,0.027724,0.028497,0.029314,0.03018,0.031099,0.032076,0.033116,0.034225,0.035408,0.036675,0.038033,0.039492,0.041063,0.042759,0.044594,0.046587],[0.024303,0.024893,0.025515,0.026168,0.026855,0.02758,0.028346,0.029156,0.030014,0.030924,0.031891,0.032921,0.034018,0.035189,0.036442,0.037785,0.039228,0.040781,0.042457,0.04427,0.046238],[0.024189,0.024775,0.025391,0.026038,0.02672,0.027438,0.028197,0.028999,0.029849,0.03075,0.031708,0.032727,0.033813,0.034972,0.036212,0.037541,0.038967,0.040502,0.042159,0.04395,0.045894],[0.024076,0.024657,0.025268,0.02591,0.026586,0.027297,0.02805,0.028845,0.029686,0.030578,0.031527,0.032536,0.033611,0.034758,0.035984,0.037299,0.038709,0.040228,0.041865,0.043635,0.045556],[0.023965,0.024541,0.025147,0.025783,0.026453,0.027158,0.027904,0.028691,0.029525,0.030409,0.031348,0.032347,0.033411,0.034546,0.03576,0.03706,0.038455,0.039957,0.041575,0.043324,0.045222],[0.023855,0.024426,0.025026,0.025657,0.026321,0.02702,0.027759,0.02854,0.029365,0.030241,0.031171,0.032161,0.033214,0.034337,0.035538,0.036825,0.038205,0.039689,0.041289,0.043018,0.044893],[0.023745,0.024312,0.024907,0.025533,0.026191,0.026884,0.027616,0.028389,0.029208,0.030075,0.030996,0.031976,0.033019,0.034131,0.035319,0.036592,0.037957,0.039425,0.041007,0.042716,0.044569],[0.023637,0.024199,0.024789,0.025409,0.026062,0.026749,0.027475,0.028241,0.029052,0.029911,0.030823,0.031794,0.032826,0.033927,0.035103,0.036363,0.037713,0.039165,0.040729,0.042418,0.044249],[0.023529,0.024086,0.024672,0.025287,0.025934,0.026615,0.027334,0.028094,0.028897,0.029748,0.030652,0.031613,0.032635,0.033725,0.03489,0.036136,0.037472,0.038908,0.040455,0.042125,0.043934],[0.023423,0.023975,0.024556,0.025166,0.025808,0.026483,0.027196,0.027948,0.028744,0.029588,0.030483,0.031435,0.032447,0.033526,0.034679,0.035912,0.037234,0.038654,0.040184,0.041835,0.043624],[0.023317,0.023865,0.024441,0.025046,0.025682,0.026352,0.027059,0.027804,0.028593,0.029429,0.030316,0.031258,0.032261,0.033329,0.03447,0.035691,0.036999,0.038404,0.039917,0.04155,0.043318],[0.023213,0.023756,0.024328,0.024928,0.025558,0.026222,0.026923,0.027662,0.028444,0.029272,0.030151,0.031084,0.032077,0.033134,0.034264,0.035472,0.036766,0.038157,0.039653,0.041268,0.043016],[0.023109,0.023648,0.024215,0.02481,0.025436,0.026094,0.026788,0.027521,0.028296,0.029116,0.029987,0.030912,0.031895,0.032942,0.03406,0.035256,0.036537,0.037913,0.039393,0.04099,0.042718],[0.023006,0.023541,0.024104,0.024694,0.025314,0.025966,0.026655,0.027381,0.028149,0.028962,0.029825,0.030741,0.031715,0.032752,0.033859,0.035043,0.036311,0.037672,0.039136,0.040716,0.042425],[0.022904,0.023435,0.023993,0.024578,0.025193,0.02584,0.026523,0.027243,0.028004,0.02881,0.029665,0.030572,0.031537,0.032564,0.033661,0.034833,0.036087,0.037434,0.038883,0.040445,0.042135],[0.022803,0.02333,0.023883,0.024464,0.025074,0.025716,0.026392,0.027106,0.027861,0.028659,0.029506,0.030405,0.031361,0.032378,0.033464,0.034624,0.035866,0.037199,0.038633,0.040178,0.041849],[0.022703,0.023226,0.023775,0.024351,0.024956,0.025592,0.026263,0.026971,0.027719,0.02851,0.02935,0.03024,0.031187,0.032195,0.03327,0.034419,0.035648,0.036967,0.038386,0.039915,0.041567],[0.022604,0.023123,0.023667,0.024238,0.024839,0.02547,0.026135,0.026837,0.027578,0.028362,0.029194,0.030077,0.031015,0.032013,0.033078,0.034216,0.035433,0.036738,0.038142,0.039654,0.041289],[0.022506,0.023021,0.023561,0.024127,0.024723,0.025348,0.026008,0.026704,0.027439,0.028216,0.029041,0.029916,0.030845,0.031834,0.032888,0.034015,0.03522,0.036512,0.037901,0.039398,0.041015],[0.022408,0.022919,0.023455,0.024017,0.024608,0.025228,0.025883,0.026573,0.027301,0.028072,0.028889,0.029756,0.030677,0.031656,0.032701,0.033816,0.035009,0.036289,0.037664,0.039144,0.040744],[0.022312,0.022819,0.02335,0.023908,0.024494,0.025109,0.025758,0.026442,0.027165,0.027929,0.028739,0.029598,0.03051,0.03148,0.032515,0.03362,0.034801,0.036068,0.037429,0.038894,0.040477],[0.022216,0.022719,0.023246,0.0238,0.024381,0.024991,0.025635,0.026313,0.02703,0.027787,0.02859,0.029441,0.030345,0.031307,0.032332,0.033426,0.034596,0.03585,0.037197,0.038647,0.040213],[0.022121,0.02262,0.023144,0.023693,0.024269,0.024875,0.025513,0.026186,0.026896,0.027647,0.028443,0.029287,0.030183,0.031135,0.03215,0.033234,0.034393,0.035635,0.036968,0.038403,0.039953],[0.022027,0.022522,0.023042,0.023586,0.024158,0.024759,0.025392,0.026059,0.026764,0.027508,0.028297,0.029134,0.030021,0.030965,0.031971,0.033045,0.034192,0.035422,0.036742,0.038162,0.039696],[0.021933,0.022425,0.022941,0.023481,0.024048,0.024644,0.025273,0.025934,0.026633,0.027371,0.028153,0.028982,0.029862,0.030797,0.031794,0.032857,0.033994,0.035211,0.036519,0.037925,0.039443],[0.021841,0.022329,0.02284,0.023377,0.02394,0.024531,0.025154,0.02581,0.026503,0.027235,0.02801,0.028832,0.029704,0.030631,0.031619,0.032672,0.033798,0.035004,0.036298,0.03769,0.039192]]};

        // ═══════ COSTANTI ═══════
        const ASSEGNO_SOCIALE_2026 = 7101.12;
        const ANNO_CORRENTE = 2026;
        const ANNO_BASE_STATIC = 0; // index 0 = 2024 (ultimo dato reale)

        const fmt  = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
        const fmt2 = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 2 });
        const fmtN = new Intl.NumberFormat('it-IT', { maximumFractionDigits: 0 });

        let chartInstance = null;
        let coeffMode = 'static'; // 'static' | 'dynamic'

        // ═══════ LOOKUP COEFFICIENTE ═══════
        function lookupCoeff(sesso, annoUscita, etaUscita, mode) {
            const matrix = sesso === 'M' ? COEFF_DATA.M : COEFF_DATA.F;
            const years = COEFF_DATA.years;
            const ages  = COEFF_DATA.ages;

            // Anno: statico = colonna 0 (2024), dinamico = colonna proiettata
            let yIdx;
            if (mode === 'static') {
                yIdx = ANNO_BASE_STATIC;
            } else {
                if (annoUscita <= years[0]) yIdx = 0;
                else if (annoUscita >= years[years.length - 1]) yIdx = years.length - 1;
                else {
                    yIdx = years.indexOf(annoUscita);
                    if (yIdx === -1) yIdx = years.findIndex(y => y >= annoUscita) || years.length - 1;
                }
            }

            // Età con interpolazione lineare
            let clampedAge = Math.max(ages[0], Math.min(ages[ages.length - 1], etaUscita));
            const aFloor = Math.floor(clampedAge);
            const aCeil  = Math.ceil(clampedAge);
            const idxFloor = ages.indexOf(aFloor);
            const idxCeil  = ages.indexOf(aCeil);

            let coeff;
            if (idxFloor !== -1 && idxCeil !== -1 && idxFloor !== idxCeil) {
                const frac = clampedAge - aFloor;
                coeff = matrix[yIdx][idxFloor] + frac * (matrix[yIdx][idxCeil] - matrix[yIdx][idxFloor]);
            } else if (idxFloor !== -1) {
                coeff = matrix[yIdx][idxFloor];
            } else {
                coeff = matrix[0][10]; // fallback 60 anni 2024
            }

            return { coeff, year: years[yIdx], age: clampedAge };
        }

        // ═══════ UI: SELEZIONE MODO COEFFICIENTE ═══════
        window.selectCoeffMode = function(mode) {
            coeffMode = mode;
            const optS = document.getElementById('optStatic');
            const optD = document.getElementById('optDynamic');
            const radS = document.getElementById('radioStatic');
            const radD = document.getElementById('radioDynamic');

            if (mode === 'static') {
                optS.className = 'coeff-option active-static border-2 rounded-xl p-4';
                optD.className = 'coeff-option border-2 border-slate-200 rounded-xl p-4';
                radS.innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-emerald-500"></div>';
                radS.className = 'w-5 h-5 rounded-full border-2 border-emerald-500 flex items-center justify-center';
                radD.innerHTML = '';
                radD.className = 'w-5 h-5 rounded-full border-2 border-slate-300 flex items-center justify-center';
            } else {
                optD.className = 'coeff-option active-dynamic border-2 rounded-xl p-4';
                optS.className = 'coeff-option border-2 border-slate-200 rounded-xl p-4';
                radD.innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-amber-500"></div>';
                radD.className = 'w-5 h-5 rounded-full border-2 border-amber-500 flex items-center justify-center';
                radS.innerHTML = '';
                radS.className = 'w-5 h-5 rounded-full border-2 border-slate-300 flex items-center justify-center';
            }
            calculate();
        };

        // ═══════ INIT ═══════
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('rendimento').addEventListener('input', (e) => {
                document.getElementById('valRend').innerText = e.target.value + '%'; calculate();
            });
            document.getElementById('inflazione').addEventListener('input', (e) => {
                document.getElementById('valInf').innerText = e.target.value + '%'; calculate();
            });
            document.getElementById('crescitaPercLav').addEventListener('input', (e) => {
                document.getElementById('valCresLav').innerText = e.target.value + '%'; calculate();
            });
            document.getElementById('crescitaPercDat').addEventListener('input', (e) => {
                document.getElementById('valCresDat').innerText = e.target.value + '%'; calculate();
            });

            ['anniAlPensionamento', 'annoNascita', 'percLav', 'percDatore', 'includeTFR', 'crescitaSalari', 'sesso'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', calculate);
                    el.addEventListener('change', calculate);
                }
            });

            calculate();
        });

        // ═══════ FORMATTING VALUTA ═══════
        function formatCurrencyInput(input) {
            let valueRaw = input.value.replace(/\D/g, '');
            if (valueRaw !== '') input.value = new Intl.NumberFormat('it-IT').format(parseInt(valueRaw));
            calculate();
        }

        function getCurrencyValue(id) {
            return parseFloat(document.getElementById(id).value.replace(/\./g, '')) || 0;
        }

        // ═══════ CALCOLO PRINCIPALE ═══════
        function calculate() {
            const montanteOggi = getCurrencyValue('montanteAttuale');
            const ral          = getCurrencyValue('ral');
            const anni         = parseInt(document.getElementById('anniAlPensionamento').value) || 0;
            const annoNascita  = parseInt(document.getElementById('annoNascita').value) || 1980;
            const pLav         = parseFloat(document.getElementById('percLav').value) / 100 || 0;
            const pDat         = parseFloat(document.getElementById('percDatore').value) / 100 || 0;
            const usaTFR       = document.getElementById('includeTFR').checked;
            const gSalari      = parseFloat(document.getElementById('crescitaSalari').value) / 100 || 0;
            const gPercLav     = parseFloat(document.getElementById('crescitaPercLav').value) / 100 || 0;
            const gPercDat     = parseFloat(document.getElementById('crescitaPercDat').value) / 100 || 0;
            const rFin         = parseFloat(document.getElementById('rendimento').value) / 100 || 0;
            const inflazione   = parseFloat(document.getElementById('inflazione').value) / 100 || 0;
            const sesso        = document.getElementById('sesso').value;

            const annoUscita = ANNO_CORRENTE + anni;
            const etaUscita  = annoUscita - annoNascita;

            document.getElementById('outEtaPensione').innerText = etaUscita;
            document.getElementById('outAnnoUscita').innerText  = annoUscita;

            // Calcola ENTRAMBI i coefficienti per mostrare il confronto
            const lookS = lookupCoeff(sesso, annoUscita, etaUscita, 'static');
            const lookD = lookupCoeff(sesso, annoUscita, etaUscita, 'dynamic');

            document.getElementById('valCoeffStatic').innerText  = (lookS.coeff * 100).toFixed(3) + '%';
            document.getElementById('valCoeffDynamic').innerText = (lookD.coeff * 100).toFixed(3) + '%';

            const delta = ((lookS.coeff - lookD.coeff) / lookS.coeff * 100);
            const deltaEl = document.getElementById('coeffDelta');
            if (delta > 0.01) {
                deltaEl.innerText = `Dinamico è ${delta.toFixed(1)}% più basso del Statico`;
                deltaEl.className = 'font-bold text-amber-600';
            } else if (delta < -0.01) {
                deltaEl.innerText = `Dinamico è ${Math.abs(delta).toFixed(1)}% più alto del Statico`;
                deltaEl.className = 'font-bold text-emerald-600';
            } else {
                deltaEl.innerText = 'Coincidono (anno uscita ≈ 2024)';
                deltaEl.className = 'font-bold text-slate-500';
            }

            // Coefficiente attivo
            const coeff = coeffMode === 'static' ? lookS.coeff : lookD.coeff;

            // Nota sesso
            document.getElementById('coeffSessoNote').innerText =
                sesso === 'F' ? 'Donna: vita attesa più lunga → coefficiente più basso a parità di età' :
                'Uomo: vita attesa minore → coefficiente più alto a parità di età';

            // Contributo anno 1
            const contribLD_1  = ral * (pLav + pDat);
            const contribTFR_1 = usaTFR ? (ral / 13.5) : 0;
            document.getElementById('outContribLD').innerText  = fmt.format(contribLD_1);
            document.getElementById('outContribTFR').innerText = fmt.format(contribTFR_1);
            document.getElementById('outContribTot').innerText = fmt.format(contribLD_1 + contribTFR_1);

            // Proiezione
            let montante      = montanteOggi;
            let currentRal    = ral;
            let currentPercLav = pLav;
            let currentPercDat = pDat;
            let dataPoints    = [montanteOggi];
            let labels        = ['Oggi'];
            let tableRows     = [];

            tableRows.push({ anno: 0, ral: currentRal, percLav: currentPercLav, percDat: currentPercDat, contribLD: 0, contribTFR: 0, contribTot: 0, rendimento: 0, montante: montanteOggi });

            for (let i = 1; i <= anni; i++) {
                const rendAnno = montante * rFin;
                montante += rendAnno;
                const contribLD  = currentRal * (currentPercLav + currentPercDat);
                const contribTFR = usaTFR ? (currentRal / 13.5) : 0;
                const contribTot = contribLD + contribTFR;
                montante += contribTot;

                tableRows.push({ anno: i, ral: currentRal, percLav: currentPercLav, percDat: currentPercDat, contribLD, contribTFR, contribTot, rendimento: rendAnno, montante });

                currentRal     *= (1 + gSalari);
                currentPercLav *= (1 + gPercLav);
                currentPercDat *= (1 + gPercDat);

                dataPoints.push(montante);
                labels.push('Anno ' + i);
            }

            const mfa             = montante;
            const asFuturo        = ASSEGNO_SOCIALE_2026 * Math.pow(1 + inflazione, anni);
            const sogliaLegge     = asFuturo * 0.50;
            const montante70      = mfa * 0.70;
            const rendita70       = montante70 * coeff;
            const canTakeCapital  = rendita70 < sogliaLegge;
            const sogliaLimMont   = sogliaLegge / (0.70 * coeff);

            updateUI(mfa, rendita70, sogliaLegge, canTakeCapital, dataPoints, labels, inflazione, anni, coeff, sogliaLimMont, tableRows);
        }

        // ═══════ AGGIORNAMENTO UI ═══════
        function updateUI(mfa, rendita70, soglia, success, data, labels, inflazione, anni, coeff, sogliaLimMont, tableRows) {
            const deflatore = Math.pow(1 + inflazione, anni);

            document.getElementById('outMFA').innerText = fmt.format(mfa);
            document.getElementById('outMFAreale').innerText = 'reale: ' + fmt.format(mfa / deflatore);
            document.getElementById('outRendita70').innerText = fmt2.format(rendita70);
            document.getElementById('outRendita70reale').innerText = 'reale: ' + fmt2.format(rendita70 / deflatore);
            document.getElementById('outSoglia').innerText = fmt2.format(soglia);
            document.getElementById('outSogliaMensile').innerText = fmt2.format(soglia / 13) + '/mese × 13';

            const gap = soglia - rendita70;
            document.getElementById('outGap').innerText = fmt2.format(Math.abs(gap));

            document.getElementById('outSogliaLimMont').innerText = fmt.format(sogliaLimMont);
            const margine = sogliaLimMont - mfa;
            const margEl  = document.getElementById('outMargineLimite');
            margEl.innerText  = (margine >= 0 ? '+' : '') + fmt.format(margine);
            margEl.className  = margine >= 0 ? 'font-semibold text-green-700' : 'font-semibold text-red-700';

            const card       = document.getElementById('resultCard');
            const gapEl      = document.getElementById('outGap');
            const gapDesc    = document.getElementById('outGapDesc');
            const dettaglio  = document.getElementById('dettaglioRendita');

            if (success) {
                card.className = 'p-8 rounded-2xl shadow-xl text-center transition-all duration-500 bg-emerald-100 border-2 border-emerald-500';
                card.innerHTML = `
                    <div class="text-emerald-800">
                        <i class="fa-solid fa-check-circle text-5xl mb-3"></i>
                        <h2 class="text-2xl font-bold uppercase">100% Capitale Prelevabile</h2>
                        <p class="mt-2 text-sm">La rendita teorica (${fmt2.format(rendita70)}) è INFERIORE alla soglia di legge (${fmt2.format(soglia)}).</p>
                        <p class="mt-1 font-semibold">Margine di sicurezza: ${fmt2.format(gap)}</p>
                        <p class="mt-1 text-xs opacity-70">Coefficiente usato: ${(coeff * 100).toFixed(3)}% (${coeffMode === 'static' ? 'Statico' : 'Dinamico'})</p>
                    </div>`;
                gapEl.className  = 'text-2xl font-bold text-emerald-600';
                gapDesc.innerText = 'Sotto la soglia (OK)';
                gapDesc.className = 'text-xs mt-1 text-emerald-600';
                dettaglio.classList.add('hidden');
            } else {
                const minRendita = mfa * 0.40 * coeff;
                card.className = 'p-8 rounded-2xl shadow-xl text-center transition-all duration-500 bg-amber-50 border-2 border-amber-500';
                card.innerHTML = `
                    <div class="text-amber-800">
                        <i class="fa-solid fa-triangle-exclamation text-5xl mb-3"></i>
                        <h2 class="text-2xl font-bold uppercase">Obbligo Rendita (Min 40%)</h2>
                        <p class="mt-2 text-sm">La rendita teorica (${fmt2.format(rendita70)}) SUPERA la soglia (${fmt2.format(soglia)}).</p>
                        <div class="mt-4 bg-white bg-opacity-60 p-3 rounded">
                            <p class="text-xs font-bold uppercase mb-1">Dovrai scegliere (dal 1/7/2026):</p>
                            <ul class="text-sm text-left list-disc pl-5">
                                <li>Max 60% Capitale: <b>${fmt.format(mfa * 0.60)}</b></li>
                                <li>Min 40% Rendita: <b>~${fmt2.format(minRendita)} annui</b></li>
                            </ul>
                        </div>
                        <p class="mt-2 text-xs opacity-70">Coefficiente usato: ${(coeff * 100).toFixed(3)}% (${coeffMode === 'static' ? 'Statico' : 'Dinamico'})</p>
                    </div>`;
                gapEl.className  = 'text-2xl font-bold text-red-600';
                gapDesc.innerText = 'Sopra la soglia (KO)';
                gapDesc.className = 'text-xs mt-1 text-red-600';

                dettaglio.classList.remove('hidden');
                document.getElementById('outMax60').innerText = fmt.format(mfa * 0.60);
                document.getElementById('outMin40rendita').innerText = fmt2.format(minRendita) + '/anno';
                document.getElementById('outMin40reale').innerText = 'reale: ' + fmt2.format(minRendita / deflatore) + '/anno';
            }

            // Tabella
            const tbody = document.getElementById('projBody');
            tbody.innerHTML = '';
            const anniPens = parseInt(document.getElementById('anniAlPensionamento').value);
            tableRows.forEach(r => {
                const isFinal = r.anno === anniPens;
                const cls = r.anno <= anniPens ? (isFinal ? 'bg-indigo-100 font-bold' : 'bg-indigo-50') : 'bg-white';
                tbody.innerHTML += `
                    <tr class="${cls} border-b border-slate-100">
                        <td class="p-1.5 text-center">${r.anno}</td>
                        <td class="p-1.5 text-right">${fmtN.format(r.ral)}</td>
                        <td class="p-1.5 text-right">${(r.percLav * 100).toFixed(2)}%</td>
                        <td class="p-1.5 text-right">${(r.percDat * 100).toFixed(2)}%</td>
                        <td class="p-1.5 text-right">${fmtN.format(r.contribLD)}</td>
                        <td class="p-1.5 text-right">${fmtN.format(r.contribTFR)}</td>
                        <td class="p-1.5 text-right">${fmtN.format(r.contribTot)}</td>
                        <td class="p-1.5 text-right">${fmtN.format(r.rendimento)}</td>
                        <td class="p-1.5 text-right font-semibold">${fmtN.format(r.montante)}</td>
                    </tr>`;
            });

            updateChart(data, labels, soglia, coeff);
        }

        // ═══════ GRAFICO ═══════
        function updateChart(data, labels, sogliaFinale, coeff) {
            const ctx = document.getElementById('projectionChart').getContext('2d');
            const capLimite = sogliaFinale / (0.7 * coeff);
            const limitLine = new Array(data.length).fill(capLimite);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Montante Accumulato',
                            data: data,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            borderWidth: 2.5
                        },
                        {
                            label: 'Soglia Limite (Capitale Max)',
                            data: limitLine,
                            borderColor: '#ef4444',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += fmt.format(context.parsed.y);
                                    return label;
                                }
                            }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { callback: function(v) { return '€' + v.toLocaleString('it-IT', { notation: 'compact' }); } },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
    </script>
</body>
</html>
